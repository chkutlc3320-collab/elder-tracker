<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·ç…§æ©Ÿæ§‹é‹å‹•ç´€éŒ„ç³»çµ± - Barcode Tracker</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®š Tailwind CSS é…ç½®ï¼Œä½¿ç”¨ Inter å­—é«”å’Œåœ“è§’ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* å°ç£å¸¸ç”¨å­—é«”è¨­å®šï¼Œç¢ºä¿ä¸­æ–‡é¡¯ç¤ºæ­£å¸¸ */
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        /* éš±è—é è¨­çš„è¨Šæ¯ç›’å­ï¼Œåªåœ¨éœ€è¦æ™‚é¡¯ç¤º */
        #messageBox {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-indigo-100">

        <!-- æ¨™é¡Œå€ -->
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-700 tracking-tight">é•·ç…§é‹å‹•æ¢ç¢¼ç´€éŒ„ç³»çµ±</h1>
            <p class="mt-2 text-lg text-gray-600">æƒææ¢ç¢¼æˆ–è¼¸å…¥ç·¨è™Ÿï¼Œè‡ªå‹•åˆ¤æ–·å ±åˆ°/ç™»å‡º</p>
        </header>

        <!-- æ¢ç¢¼è¼¸å…¥èˆ‡æ“ä½œå€ -->
        <div class="space-y-6">
            <div class="relative">
                <!-- æƒæå™¨æƒæå®Œæœƒè‡ªå‹•é€å‡º Enter è¨Šè™Ÿï¼Œè§¸ç™¼ autoCheckAction() -->
                <input type="text" id="barcodeInput" placeholder="è«‹æƒææˆ–è¼¸å…¥é•·è¼©ç·¨è™Ÿ (ä¾‹å¦‚: A001)"
                       class="w-full p-4 pl-12 text-xl border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:ring-indigo-500 transition duration-150"
                       autofocus onkeyup="if(event.key === 'Enter') autoCheckAction()">
                <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 transform -translate-y-1/2 h-6 w-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10m6-10v10m6-10v10m6-10v10M8 5h8M8 19h8" />
                </svg>
            </div>

            <!-- é‹å‹•é …ç›®é¸æ“‡ (é•·è¼©å ±åˆ°å‰é¡¯ç¤º) -->
            <div id="exerciseTypeContainer">
                <label for="exerciseType" class="block text-lg font-medium text-gray-700 mb-2">è«‹é¸æ“‡é‹å‹•é …ç›® (å ±åˆ°å‰è«‹å…ˆé¸)ï¼š</label>
                <select id="exerciseType" class="w-full p-3 border border-gray-300 rounded-lg">
                    <option value="å¥èº«è»Š">å¥èº«è»Š</option>
                    <option value="å¥èµ°">å¥èµ°/æ•£æ­¥</option>
                    <option value="ä¸‹è‚¢è‚ŒåŠ›" selected>ä¸‹è‚¢è‚ŒåŠ›è¨“ç·´</option>
                    <option value="æ‰‹çœ¼å”èª¿">æ‰‹çœ¼å”èª¿éŠæˆ²</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            
            <!-- å–®ä¸€åŸ·è¡ŒæŒ‰éˆ• (æä¾›æ‰‹å‹•é»æ“Š) -->
            <button onclick="autoCheckAction(true)" id="actionButton" disabled
                    class="w-full py-4 text-white font-bold text-xl rounded-xl transition duration-300 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed bg-indigo-500 hover:bg-indigo-600">
                <span id="actionText">è«‹æƒæé•·è¼©ç·¨è™Ÿ...</span>
            </button>
        </div>

        <!-- è¨Šæ¯èˆ‡çµæœé¡¯ç¤ºå€ -->
        <div id="resultsContainer" class="mt-8 pt-6 border-t border-indigo-200">
            <!-- è¨Šæ¯ç›’å­ -->
            <div id="messageBox" class="p-4 rounded-lg text-center font-semibold mb-4 bg-blue-100 text-blue-700">
                æ­¡è¿ä½¿ç”¨ç³»çµ±ã€‚è«‹æƒæé•·è¼©æ¢ç¢¼ã€‚
            </div>

            <!-- é•·è¼©è³‡è¨Šå¡ -->
            <div id="elderCard" class="hidden bg-indigo-50 border-2 border-indigo-200 rounded-xl p-5 sm:p-6 shadow-md">
                <h3 class="text-2xl font-bold text-indigo-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.938 13.938 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="elderNameDisplay"></span> (<span id="elderIdDisplay"></span>)
                </h3>
                <div class="grid grid-cols-2 gap-4 text-lg">
                    <div>
                        <p class="text-gray-500">ç•¶å‰ç‹€æ…‹ï¼š</p>
                        <p id="statusDisplay" class="font-bold text-xl text-green-600">æœªå ±åˆ°</p>
                    </div>
                    <div>
                        <p class="text-gray-500">ç¸½é‹å‹•æ¬¡æ•¸ï¼š</p>
                        <p id="totalSessionsDisplay" class="font-bold text-xl text-indigo-600">0 æ¬¡</p>
                    </div>
                    <div class="col-span-2">
                        <p class="text-gray-500">åŠ å…¥ç´€éŒ„æœˆä»½ï¼š</p>
                        <p id="monthsDisplay" class="font-bold text-xl text-indigo-600">0 å€‹æœˆ</p>
                    </div>
                </div>
            </div>

            <!-- æœ€æ–°é‹å‹•ç´€éŒ„ -->
            <div id="currentSession" class="mt-4 p-4 rounded-lg bg-yellow-100 text-yellow-800 hidden">
                <p class="font-semibold">ç•¶å‰é‹å‹•ç´€éŒ„ï¼š</p>
                <p id="currentSessionInfo"></p>
            </div>

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, limit, orderBy, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================================================================================================
        // ã€ğŸ”¥ğŸ”¥ğŸ”¥ æ­¥é©Ÿå››ï¼šè²¼ä¸Šå…¬å¸å°ˆæ¡ˆçš„è¨­å®š ğŸ”¥ğŸ”¥ğŸ”¥ã€‘
        
        // ğŸš¨ å€å¡Š A: è«‹å°‡æ‚¨å¾ Firebase è¤‡è£½çš„ appId å­—ä¸²è²¼åœ¨é€™è£¡ (è¨˜å¾—ä¿ç•™å–®å¼•è™Ÿ ' ' )
        const appId = '1:650885065081:web:8a4089d850d0acf1cce7a8'; 
        
        // ğŸš¨ å€å¡Š B: è«‹å°‡æ‚¨å¾ Firebase è¤‡è£½çš„å®Œæ•´ firebaseConfig ç‰©ä»¶è²¼åœ¨é€™è£¡ (å¾ { åˆ° } )
        const firebaseConfig = {apiKey: "AIzaSyD4O9S_XY_aqHkhj_p5rwzmnIG-5g4Hkd4",
    authDomain: "worktime-e6790.firebaseapp.com",
    projectId: "worktime-e6790",
    storageBucket: "worktime-e6790.firebasestorage.app",
    messagingSenderId: "650885065081",
    appId: "1:650885065081:web:8a4089d850d0acf1cce7a8",
    measurementId: "G-FLNC9H9FZK"
        };
        
        // æ­¤è™•ä¸éœ€è¦ä¿®æ”¹
        const initialAuthToken = null; 
        
        // ====================================================================================================================================================


        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let unsubscribeProfile = null;
        let unsubscribeSessions = null;
        let currentBarcodeId = null;
        let activeSessionId = null; // æ–°å¢ï¼šç”¨æ–¼ä¿å­˜ç•¶å‰é€²è¡Œä¸­çš„ Session ID

        // å…¨åŸŸè®Šæ•¸ä¾› HTML å…§è¯èª¿ç”¨
        window.autoCheckAction = autoCheckAction;

        // UI å…ƒç´ 
        const barcodeInput = document.getElementById('barcodeInput');
        const elderCard = document.getElementById('elderCard');
        const actionButton = document.getElementById('actionButton');
        const actionText = document.getElementById('actionText');
        const exerciseTypeContainer = document.getElementById('exerciseTypeContainer');
        const exerciseTypeSelect = document.getElementById('exerciseType');
        const currentSessionDiv = document.getElementById('currentSession');
        const currentSessionInfo = document.getElementById('currentSessionInfo');

        // è¼”åŠ©å‡½æ•¸ï¼šé¡¯ç¤ºè¨Šæ¯
        function showMessage(text, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = text;
            messageBox.className = 'p-4 rounded-lg text-center font-semibold mb-4';

            let bgColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-700';
                    break;
                case 'error':
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-700';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-100';
                    textColor = 'text-yellow-700';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-blue-100';
                    textColor = 'text-blue-700';
                    break;
            }

            messageBox.classList.add(bgColor, textColor);
            messageBox.style.opacity = 1;
            setTimeout(() => {
                messageBox.style.opacity = 0;
            }, 3000); // 3 ç§’å¾Œéš±è—
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–æ™‚é–“
        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('zh-TW', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: false
            });
        }

        // --- Firebase åˆå§‹åŒ–èˆ‡é©—è­‰ ---
        if (firebaseConfig && firebaseConfig.projectId && appId && !appId.includes('åœ¨é€™è£¡è²¼ä¸Š')) { // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ firebaseConfig
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        showMessage('Firebase é€£ç·šæˆåŠŸï¼Œä½¿ç”¨è€…å·²ç™»å…¥ã€‚', 'success');
                    } else {
                        // é¦–æ¬¡ç™»å…¥æˆ–é‡æ–°æ•´ç†
                        try {
                            // ç”±æ–¼å·²åˆ‡æ›åˆ°å…¬å¸å°ˆæ¡ˆï¼Œé€™è£¡åªéœ€ä½¿ç”¨åŒ¿åç™»å…¥
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Firebase ç™»å…¥å¤±æ•—:", error);
                            showMessage('Firebase ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®ã€‚', 'error');
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                showMessage('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase é…ç½®ã€‚', 'error');
            }
        } else {
            showMessage('âš ï¸ ç¼ºå°‘ Firebase è¨­å®šã€‚è«‹å®Œæˆæ­¥é©Ÿå››çš„æ›¿æ›ï¼', 'error');
        }

        // --- Firestore è·¯å¾‘å®šç¾© ---
        const getProfilePath = (id) => `artifacts/${appId}/users/${userId}/elder_profiles/${id}`;
        const getSessionCollectionPath = () => `artifacts/${appId}/users/${userId}/session_logs`;

        // --- è³‡æ–™ç›£è½èˆ‡çµ±è¨ˆè¨ˆç®— ---
        function attachListeners(barcodeId) {
            if (!isAuthReady || !db) return;

            // 1. ç›£è½é•·è¼©å€‹äººè³‡æ–™
            if (unsubscribeProfile) unsubscribeProfile();
            const profileRef = doc(db, getProfilePath(barcodeId));
            unsubscribeProfile = onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    const profile = docSnap.data();
                    displayElderInfo(profile, barcodeId);
                } else {
                    // å¦‚æœé•·è¼©ä¸å­˜åœ¨ï¼Œå‰‡å¼•å°è¨»å†Š
                    registerNewElder(barcodeId);
                }
            }, (error) => {
                console.error("ç›£è½é•·è¼©è³‡æ–™å¤±æ•—:", error);
                showMessage('é•·è¼©è³‡æ–™è®€å–å¤±æ•—ã€‚', 'error');
            });

            // 2. ç›£è½è©²é•·è¼©çš„æ‰€æœ‰é‹å‹•ç´€éŒ„ä¸¦è¨ˆç®—çµ±è¨ˆ
            if (unsubscribeSessions) unsubscribeSessions();
            const sessionsColRef = collection(db, getSessionCollectionPath());
            // æŸ¥è©¢è©²é•·è¼©çš„æ‰€æœ‰ç´€éŒ„ï¼Œä¸¦ç›£è½æœ€æ–°ä¸€å€‹ active session
            const q = query(
                sessionsColRef,
                where("barcodeId", "==", barcodeId),
                orderBy("checkIn", "desc")
            );

            unsubscribeSessions = onSnapshot(q, (snapshot) => {
                let totalSessions = 0;
                let activeSession = null;
                activeSessionId = null; // é‡è¨­ active session ID

                snapshot.docs.forEach(doc => {
                    const session = doc.data();
                    if (session.checkOut) {
                        // è¨ˆç®—å·²å®Œæˆçš„æ¬¡æ•¸
                        totalSessions++;
                    } else if (!activeSession) {
                        // æ‰¾åˆ°æœ€æ–°çš„æ´»å‹•ä¸­ session
                        activeSession = { id: doc.id, ...session };
                        activeSessionId = doc.id;
                    }
                });

                updateStatistics(totalSessions, activeSession);
            }, (error) => {
                console.error("ç›£è½é‹å‹•ç´€éŒ„å¤±æ•—:", error);
                showMessage('é‹å‹•ç´€éŒ„è®€å–å¤±æ•—ã€‚', 'error');
            });
        }

        // --- é¡¯ç¤º/æ›´æ–° UI å‡½æ•¸ ---
        let currentProfile = null;
        function displayElderInfo(profile, id) {
            currentProfile = profile;
            elderCard.classList.remove('hidden');

            document.getElementById('elderNameDisplay').textContent = profile.name || 'æœªçŸ¥é•·è¼©';
            document.getElementById('elderIdDisplay').textContent = id;
            
            // è¨ˆç®—åŠ å…¥æœˆæ•¸
            const enrollDate = profile.enrollDate ? profile.enrollDate.toDate() : new Date();
            const today = new Date();
            const months = (today.getFullYear() - enrollDate.getFullYear()) * 12 + (today.getMonth() - enrollDate.getMonth());
            document.getElementById('monthsDisplay').textContent = Math.max(0, months) + ' å€‹æœˆ';

            updateActionButton('ready-checkin'); // é è¨­æº–å‚™å ±åˆ°

            // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦é‡æ–°èšç„¦
            barcodeInput.value = '';
            barcodeInput.focus();

            showMessage(`æ­¡è¿ï¼Œ${profile.name}ï¼è«‹é¸æ“‡é …ç›®å¾Œæƒæå‹•ä½œã€‚`, 'info');
        }

        function updateStatistics(totalSessions, activeSession) {
            document.getElementById('totalSessionsDisplay').textContent = totalSessions + ' æ¬¡';

            // æ ¹æ“šæ˜¯å¦æœ‰ active session æ›´æ–°ç‹€æ…‹
            if (activeSession) {
                document.getElementById('statusDisplay').textContent = 'é‹å‹•ä¸­';
                document.getElementById('statusDisplay').classList.remove('text-green-600', 'text-gray-500');
                document.getElementById('statusDisplay').classList.add('text-red-600');
                
                // é‹å‹•ä¸­ï¼ŒæŒ‰éˆ•æ‡‰é¡¯ç¤ºç™»å‡º
                updateActionButton('ready-checkout');

                exerciseTypeContainer.classList.add('hidden');
                currentSessionDiv.classList.remove('hidden');
                currentSessionInfo.innerHTML = `
                    <p>é …ç›®ï¼š<span class="font-bold">${activeSession.exerciseType || 'æœªæŒ‡å®š'}</span></p>
                    <p>å ±åˆ°æ™‚é–“ï¼š<span class="font-bold">${formatTime(activeSession.checkIn)}</span></p>
                    <p class="text-xs mt-1">è«‹å†æ¬¡æƒææ¢ç¢¼ä»¥ç™»å‡º</p>
                `;
            } else {
                document.getElementById('statusDisplay').textContent = 'ä¼‘æ¯ä¸­';
                document.getElementById('statusDisplay').classList.remove('text-red-600', 'text-gray-500');
                document.getElementById('statusDisplay').classList.add('text-green-600');
                
                // ä¼‘æ¯ä¸­ï¼ŒæŒ‰éˆ•æ‡‰é¡¯ç¤ºå ±åˆ°
                updateActionButton('ready-checkin');

                exerciseTypeContainer.classList.remove('hidden');
                currentSessionDiv.classList.add('hidden');
            }
        }
        
        function updateActionButton(state) {
            actionButton.disabled = false;
            actionButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'bg-red-500', 'hover:bg-red-600', 'bg-indigo-500', 'hover:bg-indigo-600');

            if (state === 'ready-checkin') {
                actionText.textContent = 'æ‰‹å‹•å ±åˆ° (ä¼‘æ¯ä¸­)';
                actionButton.classList.add('bg-green-500', 'hover:bg-green-600');
                actionButton.dataset.action = 'checkin';
            } else if (state === 'ready-checkout') {
                actionText.textContent = 'æ‰‹å‹•ç™»å‡º (é‹å‹•ä¸­)';
                actionButton.classList.add('bg-red-500', 'hover:bg-red-600');
                actionButton.dataset.action = 'checkout';
            } else {
                actionText.textContent = 'è«‹æƒæé•·è¼©ç·¨è™Ÿ...';
                actionButton.disabled = true;
                actionButton.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
            }
        }


        // --- æ ¸å¿ƒæ“ä½œå‡½æ•¸ ---
        
        // å¤–éƒ¨å‘¼å«ï¼šæƒæå™¨æŒ‰ä¸‹ Enter æˆ–æ‰‹å‹•é»æ“ŠæŒ‰éˆ•
        async function autoCheckAction(isManualClick = false) {
            if (!isAuthReady || !db) {
                showMessage('ç³»çµ±å°šæœªåˆå§‹åŒ–å®Œæˆï¼Œè«‹ç¨å€™ã€‚', 'warning');
                return;
            }

            const barcodeId = barcodeInput.value.trim().toUpperCase();
            if (!barcodeId) {
                // å¦‚æœæ˜¯æ‰‹å‹•é»æ“Šï¼Œä¸”è¼¸å…¥æ¡†æ˜¯ç©ºçš„ï¼Œå‰‡ä¸èƒ½åŸ·è¡Œ
                if (isManualClick) {
                    showMessage('è«‹å…ˆæƒææˆ–è¼¸å…¥é•·è¼©ç·¨è™Ÿã€‚', 'warning');
                }
                return;
            }

            currentBarcodeId = barcodeId;
            
            // 1. é‡æ–°å•Ÿå‹•ç›£è½å™¨ï¼Œç¢ºä¿è³‡æ–™è®€å–ä¸¦æ›´æ–° UI ç‹€æ…‹
            // attachListeners(barcodeId); // é€™è£¡ä¸åšï¼Œé¿å…ç«¶æ…‹æ¢ä»¶ã€‚åœ¨ç™»å…¥/ç™»å‡ºå¾Œå†æ›´æ–°ã€‚

            // 2. åŸ·è¡ŒåŒæ­¥æŸ¥è©¢ï¼Œåˆ¤æ–·é•·è¼©ç•¶å‰ç‹€æ…‹
            const activeSession = await findActiveSession(barcodeId);

            if (activeSession) {
                // æ‰¾åˆ°é€²è¡Œä¸­çš„ç´€éŒ„ -> åŸ·è¡Œç™»å‡º
                await handleCheckOut(barcodeId, activeSession);
            } else {
                // æœªæ‰¾åˆ°é€²è¡Œä¸­çš„ç´€éŒ„ -> åŸ·è¡Œå ±åˆ°
                // åœ¨å ±åˆ°å‰ï¼Œå…ˆç¢ºä¿é•·è¼©è³‡æ–™å·²è¼‰å…¥ (è¨»å†Š)
                const profileExists = await checkProfileExists(barcodeId);
                if (profileExists) {
                    await handleCheckIn(barcodeId);
                }
                // å¦‚æœé•·è¼©ä¸å­˜åœ¨ï¼Œæœƒåœ¨ attachListeners çš„ onSnapshot è£¡å¼•å°è¨»å†Š
            }
            
            // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦é‡æ–°èšç„¦ï¼Œæ–¹ä¾¿ä¸‹ä¸€ä½é•·è¼©æ“ä½œ
            barcodeInput.value = '';
            barcodeInput.focus();
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæª¢æŸ¥é•·è¼©è³‡æ–™æ˜¯å¦å­˜åœ¨ (é¿å…åœ¨ autoCheckAction ä¸­é‡è¤‡è¨»å†Š)
        async function checkProfileExists(barcodeId) {
            try {
                const profileRef = doc(db, getProfilePath(barcodeId));
                const docSnap = await getDoc(profileRef);
                if (!docSnap.exists()) {
                    // å¦‚æœä¸å­˜åœ¨ï¼Œæ‰‹å‹•è§¸ç™¼è¨»å†Šæµç¨‹
                    registerNewElder(barcodeId); 
                    return false;
                }
                currentProfile = docSnap.data();
                return true;
            } catch (error) {
                console.error("æª¢æŸ¥é•·è¼©è³‡æ–™å¤±æ•—:", error);
                showMessage('æª¢æŸ¥é•·è¼©è³‡æ–™å¤±æ•—ã€‚', 'error');
                return false;
            }
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæŸ¥æ‰¾é•·è¼©çš„ active session (åŒæ­¥æŸ¥è©¢)
        async function findActiveSession(barcodeId) {
            try {
                const sessionsColRef = collection(db, getSessionCollectionPath());
                const q = query(
                    sessionsColRef,
                    where("barcodeId", "==", barcodeId),
                    where("checkOut", "==", null),
                    limit(1)
                );
                
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const docToUpdate = snapshot.docs[0];
                    return { id: docToUpdate.id, data: docToUpdate.data() };
                }
                return null;
            } catch (error) {
                console.error("æŸ¥æ‰¾æ´»å‹•ä¸­ç´€éŒ„å¤±æ•—:", error);
                showMessage('æŸ¥æ‰¾æ´»å‹•ä¸­ç´€éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
                return null;
            }
        }


        async function registerNewElder(barcodeId) {
            // å¦‚æœé•·è¼©ä¸å­˜åœ¨ï¼Œæç¤ºè¨»å†Š
            const newName = prompt(`é•·è¼©ç·¨è™Ÿ ${barcodeId} å°šæœªè¨»å†Šã€‚è«‹è¼¸å…¥é•·è¼©å§“åä»¥å®Œæˆè¨»å†Šï¼š`);
            if (!newName || newName.trim() === '') {
                showMessage('è¨»å†Šå–æ¶ˆã€‚è«‹é‡æ–°æƒæã€‚', 'warning');
                elderCard.classList.add('hidden');
                barcodeInput.focus();
                return;
            }

            try {
                const profileRef = doc(db, getProfilePath(barcodeId));
                await setDoc(profileRef, {
                    name: newName.trim(),
                    enrollDate: serverTimestamp(), // ä½¿ç”¨ä¼ºæœå™¨æ™‚é–“ä½œç‚ºåŠ å…¥æ—¥æœŸ
                    barcodeId: barcodeId
                }, { merge: true });

                showMessage(`${newName} (ç·¨è™Ÿ ${barcodeId}) è¨»å†ŠæˆåŠŸï¼`, 'success');
                // è¨»å†ŠæˆåŠŸå¾Œï¼Œæ›´æ–° UI
                attachListeners(barcodeId); 
            } catch (error) {
                console.error("è¨»å†Šæ–°é•·è¼©å¤±æ•—:", error);
                showMessage('é•·è¼©è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            }
        }

        async function handleCheckIn(barcodeId) {
            const exerciseType = exerciseTypeSelect.value;
            
            try {
                const sessionsColRef = collection(db, getSessionCollectionPath());
                await addDoc(sessionsColRef, {
                    barcodeId: barcodeId,
                    checkIn: serverTimestamp(),
                    checkOut: null, // å°šæœªçµæŸ
                    exerciseType: exerciseType,
                    name: currentProfile ? currentProfile.name : 'N/A' // å†—é¤˜æ¬„ä½æ–¹ä¾¿æŸ¥è©¢
                });
                showMessage(`${currentProfile.name} (ç·¨è™Ÿ ${barcodeId}) å ±åˆ°æˆåŠŸï¼é–‹å§‹é€²è¡Œã€${exerciseType}ã€‘ã€‚`, 'success');
                // æˆåŠŸå¾Œæ‰‹å‹•æ›´æ–°ç›£è½å™¨ä»¥åˆ·æ–° UI
                attachListeners(barcodeId);
            } catch (error) {
                console.error("å ±åˆ°å¤±æ•—:", error);
                showMessage('å ±åˆ°ç´€éŒ„å¯«å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            }
        }

        async function handleCheckOut(barcodeId, activeSession) {
            if (!activeSession) {
                 showMessage('æœªæ‰¾åˆ°é€²è¡Œä¸­çš„é‹å‹•ç´€éŒ„ã€‚', 'warning');
                 return;
            }

            try {
                const docToUpdate = doc(db, getSessionCollectionPath(), activeSession.id);
                const sessionData = activeSession.data;

                await updateDoc(docToUpdate, {
                    checkOut: serverTimestamp(),
                });

                // è¨ˆç®—é‹å‹•æ™‚é•· (ç²—ç•¥è¨ˆç®—ï¼Œä»¥ä¼ºæœå™¨æ™‚é–“ç‚ºä¸»)
                const checkInTime = sessionData.checkIn.toDate().getTime();
                const checkOutTime = new Date().getTime();
                const durationMs = checkOutTime - checkInTime;
                const durationMinutes = Math.round(durationMs / 60000);

                showMessage(`${currentProfile.name} çµæŸé‹å‹•ï¼ã€${sessionData.exerciseType}ã€‘å…±é€²è¡Œç´„ ${durationMinutes} åˆ†é˜ã€‚`, 'success');
                // æˆåŠŸå¾Œæ‰‹å‹•æ›´æ–°ç›£è½å™¨ä»¥åˆ·æ–° UI
                attachListeners(barcodeId);
            } catch (error) {
                console.error("çµæŸé‹å‹•å¤±æ•—:", error);
                showMessage('çµæŸé‹å‹•ç´€éŒ„å¯«å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            }
        }
    </script>

</body>
</html>